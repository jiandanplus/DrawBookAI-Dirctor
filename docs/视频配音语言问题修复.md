# 视频配音语言问题修复说明

## 问题描述

用户反馈：在剧本与故事设置中使用中文，场景提示词、台词也都是中文，但生成的视频配音却是英文。

## 问题根源

在 `components/StageDirector.tsx` 文件中，视频生成时构建的提示词（prompt）是用**英文**写的。虽然其中包含了中文的 `actionSummary`（动作描述）和 `cameraMovement`（镜头运动），但提示词的整体框架和技术要求都是英文的。

视频生成 API（Sora-2 和 Veo）会根据提示词的主要语言来决定配音语言，因此即使内容是中文，但由于提示词框架是英文，API 就生成了英文配音。

### 问题代码位置

**文件**: `components/StageDirector.tsx`  
**行数**: 178-193（修复前）

```typescript
// 原来的代码（英文提示词）
let videoPrompt = shot.actionSummary;
if (selectedModel === 'sora-2') {
  videoPrompt = `Generate a smooth transition video from the first image (start frame) to the second image (end frame).

Action Description: ${shot.actionSummary}

Technical Requirements:
- CRITICAL: The video MUST begin with the exact composition of the first image...
- Aspect Ratio: 16:9 widescreen landscape format
- Camera Movement: ${shot.cameraMovement}
...`;
}
```

## 解决方案

### 1. 根据项目语言动态构建提示词

修改 `handleGenerateVideo` 函数，使其根据项目设置的语言（`project.language` 或 `project.scriptData?.language`）来构建相应语言的提示词。

### 2. 明确指定配音语言

在提示词中添加明确的语言指示：
- **中文项目**: `配音语言：使用中文配音`
- **其他语言**: `Voiceover Language: Use ${projectLanguage} for voiceover`

### 3. 支持两种视频模型

- **Sora-2 模型**: 使用详细的技术要求提示词
- **Veo 模型**: 使用简化的提示词 + 语言指示

## 修复后的代码

```typescript
// Get project language for prompt generation
const projectLanguage = project.language || project.scriptData?.language || '中文';

// Build video prompt based on model and language
let videoPrompt = shot.actionSummary;

if (selectedModel === 'sora-2') {
  // 根据项目语言构建提示词
  if (projectLanguage === '中文') {
    videoPrompt = `从第一张图片（起始帧）到第二张图片（结束帧）生成平滑过渡的视频。

动作描述：${shot.actionSummary}

技术要求：
- 关键：视频必须从第一张图片的精确构图开始，逐渐过渡到第二张图片的精确构图结束
- 画面比例：16:9 宽屏横向格式
- 镜头运动：${shot.cameraMovement}
- 过渡：确保起始帧和结束帧之间自然流畅的运动，避免跳跃或不连续
- 视觉风格：电影质感，全程保持一致的光照和色调
- 细节：保持两帧之间角色和场景的连续性和一致性
- 语言：配音和字幕使用中文`;
  } else {
    videoPrompt = `Generate a smooth transition video from the first image (start frame) to the second image (end frame).

Action Description: ${shot.actionSummary}

Technical Requirements:
- CRITICAL: The video MUST begin with the exact composition of the first image and gradually transition to end with the exact composition of the second image
- Aspect Ratio: 16:9 widescreen landscape format
- Camera Movement: ${shot.cameraMovement}
- Transition: Ensure natural and fluid motion between start and end frames, avoid jumps or discontinuities
- Visual Style: Cinematic quality with consistent lighting and color tone throughout
- Details: Maintain character and scene continuity and consistency between both frames
- Language: Use ${projectLanguage} for voiceover and subtitles`;
  }
} else {
  // For Veo model, add language instruction to the action summary
  if (projectLanguage === '中文') {
    videoPrompt = `${shot.actionSummary}\n\n镜头运动：${shot.cameraMovement}\n配音语言：使用中文配音`;
  } else {
    videoPrompt = `${shot.actionSummary}\n\nCamera Movement: ${shot.cameraMovement}\nVoiceover Language: Use ${projectLanguage} for voiceover`;
  }
}
```

## 修复效果

修复后，系统会：

1. ✅ **自动检测项目语言**: 从项目设置中读取语言配置
2. ✅ **使用对应语言的提示词**: 中文项目使用中文提示词，英文项目使用英文提示词
3. ✅ **明确指定配音语言**: 在提示词中明确告诉 API 使用哪种语言配音
4. ✅ **支持多语言**: 支持中文、英文、日语、法语、西班牙语等多种语言
5. ✅ **兼容两种模型**: Sora-2 和 Veo 模型都能正确处理语言设置

## 使用建议

1. **设置项目语言**: 在 "Phase 01: 剧本与分镜" 阶段，确保正确设置了项目语言
2. **检查语言一致性**: 确保剧本内容、场景描述、台词等都使用同一种语言
3. **重新生成视频**: 如果之前生成的视频配音语言不对，可以点击"重新生成视频"按钮

## 技术细节

### 语言检测优先级

```typescript
const projectLanguage = project.language || project.scriptData?.language || '中文';
```

1. 优先使用 `project.language`（项目级别设置）
2. 其次使用 `project.scriptData?.language`（剧本数据中的语言）
3. 默认使用 `'中文'`

### 支持的语言列表

根据 `StageScript.tsx` 中的 `LANGUAGE_OPTIONS`：

- 中文 (Chinese)
- English (US)
- 日本語 (Japanese)
- Français (French)
- Español (Spanish)

## 相关文件

- `components/StageDirector.tsx` - 视频生成逻辑（已修复）
- `components/StageScript.tsx` - 语言选项配置
- `services/geminiService.ts` - 视频生成 API 调用
- `types.ts` - 项目数据结构定义

## 测试建议

1. 创建一个中文项目，生成视频，检查配音是否为中文
2. 创建一个英文项目，生成视频，检查配音是否为英文
3. 测试 Sora-2 和 Veo 两种模型是否都能正确处理语言
4. 测试重新生成视频功能是否正常工作

---

**修复日期**: 2025-12-18  
**修复版本**: v1.0.1  
**影响范围**: 视频生成功能  
**向后兼容**: 是

